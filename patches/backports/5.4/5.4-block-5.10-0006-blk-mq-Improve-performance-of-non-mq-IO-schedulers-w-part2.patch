--- ./block/blk-mq.c	2021-07-15 08:29:41.488225968 -0700
+++ ./block/blk-mq.c	2021-07-15 08:41:10.044438697 -0700
@@ -1538,13 +1538,25 @@
 void blk_mq_run_hw_queues(struct request_queue *q, bool async)
 {
 	struct blk_mq_hw_ctx *hctx;
+   struct blk_mq_hw_ctx *hctx, *sq_hctx;
 	int i;
 
+   sq_hctx = NULL;
+   if (blk_mq_has_sqsched(q))
+       sq_hctx = blk_mq_get_sq_hctx(q);
 	queue_for_each_hw_ctx(q, hctx, i) {
 		if (blk_mq_hctx_stopped(hctx))
 			continue;
 
 		blk_mq_run_hw_queue(hctx, async);
+		/*
+ 		* Dispatch from this hctx either if there's no hctx preferred
+ 		* by IO scheduler or if it has requests that bypass the
+ 		* scheduler.
+ 		*/
+		if (!sq_hctx || sq_hctx == hctx ||
+    		!list_empty_careful(&hctx->dispatch))
+    		blk_mq_run_hw_queue(hctx, async);
 	}
 }
 EXPORT_SYMBOL(blk_mq_run_hw_queues);
